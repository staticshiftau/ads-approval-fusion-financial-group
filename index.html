<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ads Approval Portal - Fusion Financial Group</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600;700&display=swap" rel="stylesheet">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
        }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #1877f2;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .lightbox {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            cursor: pointer;
        }
        .lightbox img, .lightbox video {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }
        .lightbox-close {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            z-index: 10001;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // =====================================================
        // CONFIGURATION - Fusion Financial Group
        // =====================================================
        const CONFIG = {
            SHEET_ID: '1oQ5tmmmCQyMFChcltKFglVB4l8WxO-oMdvY_Ab3Vcp8',
            API_KEY: 'AIzaSyABznAS0fH0tYNh6wlS_iEL08b6znNJCL8',
            CREATIVE_ASSETS_SHEET: 'Ads Masterlist',
            CLIENT_INFO_SHEET: 'Client Info',
            APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbwYh1DAmo0u30A6fK6tb6ygkGLl_FF7mp05y406j9dfo26_EHk5mc_duWn5iWsdkTTE/exec',

            // Edit mode passcode (for Static Shift team only)
            EDIT_PASSCODE: 'staticshift',

            // GDrive creative assets folder
            GDRIVE_FOLDER_URL: '',

            // Activity Log sheet tab (for team notes)
            ACTIVITY_LOG_SHEET: 'Activity Log',

            // n8n webhook URL for Slack notifications (paste your n8n webhook URL here)
            N8N_WEBHOOK_URL: 'https://n8n.srv1288954.hstgr.cloud/webhook/fusion-financial-approval-portal',

            // Portal URL (for Slack message links back to the portal)
            PORTAL_URL: '',

        // =====================================================
        // END CONFIGURATION - DO NOT EDIT BELOW THIS LINE
        // =====================================================

            COPIES_COLUMNS: {
                STATUS: 0,
                COPY_ID: 1,
                CAMPAIGN_NAME: 2,
                HEADLINE: 3,
                AD_COPY_TEXT: 4,
                NOTES: 9,
                LAST_UPDATED: 10
            },

            // Column mapping for Ads Masterlist sheet
            // A=Approval Status, B=Ad Status, C=Ad Name, D=Description, E=Campaign Angle,
            // F=Headline, G=Ad Copy (Body), H=GDrive Link, I=Direct URL (image),
            // J=Image Text, K=Client Note, L=Updated Date,
            // M=Media 2, N=Media 3, O=Media 4, P=Media 5
            ASSETS_COLUMNS: {
                APPROVAL_STATUS: 0,    // Column A
                AD_STATUS: 1,          // Column B
                AD_NAME: 2,            // Column C
                DESCRIPTION: 3,        // Column D
                CAMPAIGN_ANGLE: 4,     // Column E
                HEADLINE: 5,           // Column F
                AD_COPY_BODY: 6,       // Column G
                GDRIVE_LINK: 7,        // Column H - raw GDrive link
                DIRECT_URL: 8,         // Column I - formula-converted URL
                IMAGE_TEXT: 9,         // Column J
                CLIENT_NOTE: 10,       // Column K
                UPDATED_DATE: 11,      // Column L
                MEDIA_2: 12,           // Column M - additional media (raw GDrive or direct URL)
                MEDIA_3: 13,           // Column N
                MEDIA_4: 14,           // Column O
                MEDIA_5: 15            // Column P
            },

            CLIENT_COLUMNS: {
                CLIENT_ID: 0,
                BUSINESS_NAME: 1,
                WEBSITE_URL: 2,
                DESTINATION_URL: 3,
                PROFILE_IMAGE: 4
            },

            AD_STATUSES: {
                LAUNCHED_LEADS_NO_CALLS: { label: 'Launched - Leads, No Calls', color: '#f59e0b', icon: 'üìû' },
                LAUNCHED_NO_LEADS: { label: 'Launched - No Leads', color: '#ef4444', icon: 'üìâ' },
                LIVE: { label: 'Live', color: '#10b981', icon: 'üü¢' },
                IN_DRAFT: { label: 'In Draft', color: '#6b7280', icon: 'üìù' },
                REJECTED_BY_META: { label: 'Rejected by Meta', color: '#dc2626', icon: 'üö´' },
                NOT_LAUNCHED: { label: 'Not Launched', color: '#9ca3af', icon: '‚è∏Ô∏è' }
            }
        };

        // =====================================================
        // UTILITY FUNCTIONS
        // =====================================================

        // Convert Google Drive share links to displayable URLs
        // Replicates the sheet formula: =IF(H="","",IF(ISNUMBER(SEARCH("drive.google.com",H)),"https://lh3.googleusercontent.com/d/"&REGEXEXTRACT(H,"/d/([^/]+)"),H))
        const convertMediaUrl = (url) => {
            if (!url || !url.trim()) return null;
            url = url.trim();
            if (url.includes('drive.google.com')) {
                const match = url.match(/\/d\/([^/]+)/);
                if (match) return 'https://lh3.googleusercontent.com/d/' + match[1];
            }
            return url;
        };

        // Detect if a URL points to a video file
        const isVideoUrl = (url) => {
            if (!url) return false;
            const lower = url.toLowerCase();
            return lower.endsWith('.mp4') || lower.endsWith('.mov') ||
                   lower.endsWith('.webm') || lower.endsWith('.avi') ||
                   lower.includes('video');
        };

        // Format timestamp to relative time (e.g. "2 min ago", "yesterday")
        const getRelativeTime = (timestamp) => {
            const now = new Date();
            const date = new Date(timestamp);
            const diffMs = now - date;
            const diffMin = Math.floor(diffMs / 60000);
            const diffHr = Math.floor(diffMs / 3600000);
            const diffDay = Math.floor(diffMs / 86400000);

            if (diffMin < 1) return 'just now';
            if (diffMin < 60) return `${diffMin} min ago`;
            if (diffHr < 24) return `${diffHr} hr${diffHr > 1 ? 's' : ''} ago`;
            if (diffDay === 1) return 'yesterday';
            if (diffDay < 7) return `${diffDay} days ago`;
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        };

        // Send notification to n8n webhook (for Slack)
        const sendNotification = (eventType, data) => {
            if (!CONFIG.N8N_WEBHOOK_URL) return;
            try {
                fetch(CONFIG.N8N_WEBHOOK_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        event: eventType,
                        adName: data.adName || '',
                        details: data.details || '',
                        author: data.author || 'Team member',
                        portalUrl: CONFIG.PORTAL_URL,
                        timestamp: new Date().toISOString()
                    })
                });
            } catch (e) { /* silent fail - don't block UI */ }
        };

        // =====================================================
        // COMPONENTS
        // =====================================================

        const Lightbox = ({ mediaUrl, mediaType, onClose }) => {
            const isVideo = mediaType === 'video';
            return (
                <div className="lightbox" onClick={onClose}>
                    <span className="lightbox-close" onClick={onClose}>&times;</span>
                    {isVideo ? (
                        <video src={mediaUrl} controls autoPlay style={{ maxWidth: '90%', maxHeight: '90%' }} onClick={e => e.stopPropagation()} />
                    ) : (
                        <img src={mediaUrl} alt="Full size" />
                    )}
                </div>
            );
        };

        // Passcode modal for edit mode
        const PasscodeModal = ({ onSuccess, onClose }) => {
            const [passcode, setPasscode] = useState('');
            const [error, setError] = useState(false);

            const handleSubmit = () => {
                if (passcode === CONFIG.EDIT_PASSCODE) {
                    onSuccess();
                    onClose();
                } else {
                    setError(true);
                    setPasscode('');
                }
            };

            return (
                <div style={{
                    position: 'fixed', top: 0, left: 0, width: '100%', height: '100%',
                    background: 'rgba(0,0,0,0.5)', display: 'flex',
                    alignItems: 'center', justifyContent: 'center', zIndex: 10000
                }} onClick={onClose}>
                    <div style={{
                        background: 'white', borderRadius: '12px', padding: '32px',
                        maxWidth: '400px', width: '90%', boxShadow: '0 8px 32px rgba(0,0,0,0.2)'
                    }} onClick={e => e.stopPropagation()}>
                        <h3 style={{ marginBottom: '8px', fontSize: '18px', color: '#050505' }}>
                            Enter Edit Passcode
                        </h3>
                        <p style={{ marginBottom: '16px', fontSize: '13px', color: '#65676b' }}>
                            Team members can unlock editing to update ad copy directly.
                        </p>
                        <input
                            type="password"
                            value={passcode}
                            onChange={e => { setPasscode(e.target.value); setError(false); }}
                            onKeyDown={e => e.key === 'Enter' && handleSubmit()}
                            placeholder="Enter passcode..."
                            autoFocus
                            style={{
                                width: '100%', padding: '12px', border: `2px solid ${error ? '#ef4444' : '#e4e6eb'}`,
                                borderRadius: '8px', fontSize: '16px', marginBottom: '8px', outline: 'none'
                            }}
                        />
                        {error && <div style={{ color: '#ef4444', fontSize: '13px', marginBottom: '8px' }}>
                            Incorrect passcode. Try again.
                        </div>}
                        <button onClick={handleSubmit} style={{
                            width: '100%', padding: '12px', backgroundColor: '#1877f2',
                            color: 'white', border: 'none', borderRadius: '8px',
                            fontSize: '15px', fontWeight: '600', cursor: 'pointer', marginTop: '4px'
                        }}>
                            Unlock Editing
                        </button>
                    </div>
                </div>
            );
        };

        const getAdStatusInfo = (status) => {
            const normalized = status?.toLowerCase().replace(/\s+/g, '_');
            switch(normalized) {
                case 'launched_and_got_leads_but_no_calls_booked':
                case 'launched_-_leads,_no_calls':
                case 'leads_no_calls':
                    return CONFIG.AD_STATUSES.LAUNCHED_LEADS_NO_CALLS;
                case 'launched_and_didn\'t_get_leads':
                case 'launched_and_didnt_get_leads':
                case 'launched_-_no_leads':
                case 'no_leads':
                    return CONFIG.AD_STATUSES.LAUNCHED_NO_LEADS;
                case 'live':
                    return CONFIG.AD_STATUSES.LIVE;
                case 'in_draft':
                case 'draft':
                    return CONFIG.AD_STATUSES.IN_DRAFT;
                case 'rejected_by_meta':
                case 'meta_rejected':
                    return CONFIG.AD_STATUSES.REJECTED_BY_META;
                case 'not_launched':
                    return CONFIG.AD_STATUSES.NOT_LAUNCHED;
                default:
                    return CONFIG.AD_STATUSES.NOT_LAUNCHED;
            }
        };

        const CreativeAssetCard = ({
            asset, clientInfo, updating, onStatusUpdate, editNotes, onNotesChange,
            isAuthenticated, editingContent, onContentChange, onContentSave, savingContent, onEditClick,
            activityNotes, authorName, onAuthorChange, onPostNote, postingNote
        }) => {
            const [mediaErrors, setMediaErrors] = useState({});
            const [lightboxUrl, setLightboxUrl] = useState(null);
            const [lightboxType, setLightboxType] = useState('image');
            const [isExpanded, setIsExpanded] = useState(false);
            const [showVariants, setShowVariants] = useState(false);
            const [swappingMedia, setSwappingMedia] = useState(null); // which media slot is being swapped (0=hero, 1-4=variants)
            const [showNotes, setShowNotes] = useState(false);
            const [newNoteText, setNewNoteText] = useState('');

            const cardNotes = activityNotes[asset.rowIndex] || [];
            const noteCount = cardNotes.length;
            const isPostingNote = postingNote[asset.rowIndex];

            const variantUrls = asset.mediaUrls && asset.mediaUrls.length > 1 ? asset.mediaUrls.slice(1) : [];
            const hasVariants = variantUrls.length > 0;
            const primaryUrl = asset.mediaUrls && asset.mediaUrls.length > 0 ? asset.mediaUrls[0] : null;
            const primaryIsVideo = isVideoUrl(primaryUrl);

            const getStatusColor = (status) => {
                switch(status?.toLowerCase()) {
                    case 'approved': return '#10b981';
                    case 'needs edit': return '#f59e0b';
                    case 'rejected': return '#ef4444';
                    default: return '#e4e6eb';
                }
            };

            const adStatusInfo = getAdStatusInfo(asset.adStatus);
            const editState = editingContent[asset.rowIndex] || {};
            const isEditing = isAuthenticated && Object.keys(editState).length > 0;
            const isSaving = savingContent[asset.rowIndex];

            // For display: use edit state if editing, otherwise asset data
            const displayHeadline = editState.headline !== undefined ? editState.headline : asset.headline;
            const displayAdCopy = editState.adCopyBody !== undefined ? editState.adCopyBody : asset.adCopyBody;
            const displayDescription = editState.description !== undefined ? editState.description : asset.description;

            const adCopyText = displayAdCopy || '';
            const shouldTruncate = adCopyText.length > 150 && !isAuthenticated;
            const displayUrl = clientInfo?.websiteUrl?.replace(/^https?:\/\//, '').replace(/\/$/, '') || 'example.com';

            const handleMediaError = (idx) => {
                setMediaErrors(prev => ({ ...prev, [idx]: true }));
            };

            const openLightbox = (url) => {
                setLightboxUrl(url);
                setLightboxType(isVideoUrl(url) ? 'video' : 'image');
            };

            // Check if content has been modified (text or media)
            const hasChanges = editState.headline !== undefined || editState.adCopyBody !== undefined ||
                editState.description !== undefined || editState.mediaUrl_0 !== undefined ||
                editState.mediaUrl_1 !== undefined || editState.mediaUrl_2 !== undefined ||
                editState.mediaUrl_3 !== undefined || editState.mediaUrl_4 !== undefined;

            return (
                <>
                    <div style={{
                        backgroundColor: 'white',
                        borderRadius: '8px',
                        overflow: 'hidden',
                        boxShadow: '0 1px 2px rgba(0, 0, 0, 0.1)',
                        border: `2px solid ${getStatusColor(asset.approvalStatus)}`
                    }}>
                        {/* Header */}
                        <div style={{
                            padding: '12px',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '10px',
                            borderBottom: '1px solid #e4e6eb'
                        }}>
                            <div style={{
                                width: '40px', height: '40px', borderRadius: '50%',
                                backgroundColor: '#e4e6eb', overflow: 'hidden', flexShrink: 0
                            }}>
                                {clientInfo?.profileImage ? (
                                    <img src={clientInfo.profileImage} alt={clientInfo.businessName}
                                        style={{ width: '100%', height: '100%', objectFit: 'cover' }}
                                        onError={(e) => { e.target.style.display = 'none'; }} />
                                ) : (
                                    <div style={{
                                        width: '100%', height: '100%', display: 'flex',
                                        alignItems: 'center', justifyContent: 'center',
                                        backgroundColor: '#1877f2', color: 'white', fontSize: '18px', fontWeight: '600'
                                    }}>
                                        {(clientInfo?.businessName || 'C').charAt(0).toUpperCase()}
                                    </div>
                                )}
                            </div>

                            <div style={{ flex: 1 }}>
                                <div style={{ fontSize: '14px', fontWeight: '600', color: '#050505' }}>
                                    {clientInfo?.businessName || 'Client Name'}
                                </div>
                                <div style={{ fontSize: '12px', color: '#65676b' }}>Sponsored</div>
                            </div>

                            {/* Edit Icon */}
                            <button
                                onClick={(e) => {
                                    e.stopPropagation();
                                    if (!isAuthenticated) onEditClick();
                                }}
                                title={isAuthenticated ? 'Edit mode active' : 'Unlock editing'}
                                style={{
                                    background: 'none', border: 'none', cursor: 'pointer',
                                    fontSize: '16px', padding: '4px 8px', borderRadius: '6px',
                                    color: isAuthenticated ? '#1877f2' : '#65676b',
                                    backgroundColor: isAuthenticated ? '#e7f0ff' : 'transparent'
                                }}
                            >
                                ‚úèÔ∏è
                            </button>

                            {/* Ad Status Badge */}
                            <div style={{
                                backgroundColor: adStatusInfo.color, color: 'white',
                                padding: '4px 10px', borderRadius: '12px', fontSize: '11px',
                                fontWeight: '600', textTransform: 'uppercase', letterSpacing: '0.3px'
                            }}>
                                {adStatusInfo.icon} {adStatusInfo.label}
                            </div>
                        </div>

                        {/* Ad Copy Text - Editable when authenticated */}
                        <div style={{ padding: '8px 12px' }}>
                            {isAuthenticated ? (
                                <textarea
                                    value={displayAdCopy}
                                    onChange={e => onContentChange(asset.rowIndex, 'adCopyBody', e.target.value)}
                                    placeholder="Ad copy body..."
                                    style={{
                                        width: '100%', minHeight: '100px', padding: '10px',
                                        borderRadius: '8px', border: '2px solid #d1e0ff',
                                        fontSize: '14px', fontFamily: 'inherit', resize: 'vertical',
                                        backgroundColor: '#f8faff', lineHeight: '1.5', whiteSpace: 'pre-wrap'
                                    }}
                                />
                            ) : adCopyText ? (
                                <div style={{ fontSize: '14px', color: '#050505', lineHeight: '1.5', whiteSpace: 'pre-wrap' }}>
                                    {shouldTruncate && !isExpanded ? (
                                        <>
                                            {adCopyText.substring(0, 280)}...{' '}
                                            <span onClick={() => setIsExpanded(true)}
                                                style={{ color: '#65676b', fontWeight: '600', cursor: 'pointer' }}>
                                                See more
                                            </span>
                                        </>
                                    ) : (
                                        <>
                                            {adCopyText}
                                            {shouldTruncate && isExpanded && (
                                                <> <span onClick={() => setIsExpanded(false)}
                                                    style={{ color: '#65676b', fontWeight: '600', cursor: 'pointer' }}>
                                                    See less
                                                </span></>
                                            )}
                                        </>
                                    )}
                                </div>
                            ) : null}
                        </div>

                        {/* Hero Image/Video (always shows Column I as the main ad creative) */}
                        <div style={{ position: 'relative' }}>
                            <div
                                style={{
                                    width: '100%', minHeight: '200px', backgroundColor: '#f0f2f5',
                                    display: 'flex', alignItems: 'center', justifyContent: 'center',
                                    cursor: primaryUrl && !mediaErrors[0] && !isAuthenticated ? 'pointer' : 'default',
                                    position: 'relative'
                                }}
                                onClick={() => { if (primaryUrl && !mediaErrors[0] && !isAuthenticated) openLightbox(primaryUrl); }}
                            >
                                {primaryUrl && !mediaErrors[0] ? (
                                    primaryIsVideo ? (
                                        <video src={primaryUrl}
                                            style={{ width: '100%', maxHeight: '500px', objectFit: 'contain' }}
                                            onError={() => handleMediaError(0)} />
                                    ) : (
                                        <img src={primaryUrl} alt={asset.adName}
                                            style={{ width: '100%', maxHeight: '500px', objectFit: 'contain' }}
                                            onError={() => handleMediaError(0)} />
                                    )
                                ) : primaryUrl && mediaErrors[0] ? (
                                    <div style={{ textAlign: 'center', padding: '20px', color: '#65676b' }}>
                                        <div style={{ fontSize: '48px', marginBottom: '8px' }}>üñºÔ∏è</div>
                                        <div style={{ fontSize: '14px', marginBottom: '8px' }}>Failed to load media</div>
                                        <a href={primaryUrl} target="_blank" rel="noopener noreferrer"
                                            style={{ fontSize: '12px', color: '#1877f2', textDecoration: 'underline' }}
                                            onClick={e => e.stopPropagation()}>
                                            Open link directly
                                        </a>
                                    </div>
                                ) : (
                                    <div style={{ textAlign: 'center', color: '#65676b' }}>
                                        <div style={{ fontSize: '48px', marginBottom: '8px' }}>
                                            {primaryIsVideo ? 'üé•' : 'üì∑'}
                                        </div>
                                        <div style={{ fontSize: '14px' }}>No media</div>
                                    </div>
                                )}
                            </div>

                            {/* Swap image button (edit mode only) */}
                            {isAuthenticated && (
                                <button
                                    onClick={(e) => { e.stopPropagation(); setSwappingMedia(swappingMedia === 0 ? null : 0); }}
                                    style={{
                                        position: 'absolute', top: '10px', right: '10px',
                                        backgroundColor: 'rgba(0,0,0,0.7)', color: 'white',
                                        border: 'none', borderRadius: '8px', padding: '6px 12px',
                                        fontSize: '12px', fontWeight: '600', cursor: 'pointer',
                                        display: 'flex', alignItems: 'center', gap: '4px', zIndex: 5
                                    }}
                                >
                                    üîÑ Swap Image
                                </button>
                            )}

                            {/* URL input for swapping hero image */}
                            {swappingMedia === 0 && (
                                <div style={{
                                    padding: '10px 12px', backgroundColor: '#f0f7ff',
                                    borderTop: '2px solid #1877f2',
                                    display: 'flex', gap: '8px', alignItems: 'center'
                                }}>
                                    <input
                                        type="text"
                                        placeholder="Paste GDrive link or image URL..."
                                        value={editState.mediaUrl_0 || ''}
                                        onChange={e => onContentChange(asset.rowIndex, 'mediaUrl_0', e.target.value)}
                                        autoFocus
                                        style={{
                                            flex: 1, padding: '8px 10px', border: '2px solid #d1e0ff',
                                            borderRadius: '6px', fontSize: '13px', outline: 'none'
                                        }}
                                    />
                                    <button onClick={() => setSwappingMedia(null)}
                                        style={{
                                            padding: '8px 12px', backgroundColor: '#e4e6eb', border: 'none',
                                            borderRadius: '6px', fontSize: '12px', fontWeight: '600', cursor: 'pointer'
                                        }}>
                                        Done
                                    </button>
                                </div>
                            )}
                        </div>

                        {/* Collapsible Variant Images (Columns M-P) */}
                        {hasVariants && (
                            <div style={{ borderTop: '1px solid #e4e6eb' }}>
                                <button
                                    onClick={() => setShowVariants(!showVariants)}
                                    style={{
                                        width: '100%', padding: '10px 12px', border: 'none',
                                        backgroundColor: '#f8f9fa', cursor: 'pointer',
                                        display: 'flex', alignItems: 'center', justifyContent: 'space-between',
                                        fontSize: '13px', fontWeight: '600', color: '#1877f2'
                                    }}
                                >
                                    <span>
                                        {showVariants ? 'Hide' : 'View'} {variantUrls.length} more creative variation{variantUrls.length > 1 ? 's' : ''}
                                    </span>
                                    <span style={{ fontSize: '16px', transition: 'transform 0.2s',
                                        transform: showVariants ? 'rotate(180deg)' : 'rotate(0deg)' }}>
                                        ‚ñº
                                    </span>
                                </button>
                                {showVariants && (
                                    <div style={{
                                        display: 'grid',
                                        gridTemplateColumns: variantUrls.length === 1 ? '1fr' : 'repeat(auto-fill, minmax(160px, 1fr))',
                                        gap: '8px', padding: '12px', backgroundColor: '#f8f9fa'
                                    }}>
                                        {variantUrls.map((url, idx) => {
                                            const variantIdx = idx + 1;
                                            const isVid = isVideoUrl(url);
                                            const hasError = mediaErrors[variantIdx];
                                            return (
                                                <div key={variantIdx} style={{
                                                    position: 'relative', backgroundColor: '#fff',
                                                    borderRadius: '8px', overflow: 'hidden',
                                                    border: '1px solid #e4e6eb'
                                                }}>
                                                    <div style={{
                                                        aspectRatio: '1', overflow: 'hidden',
                                                        cursor: !hasError && !isAuthenticated ? 'pointer' : 'default'
                                                    }}
                                                    onClick={() => { if (!hasError && !isAuthenticated) openLightbox(url); }}>
                                                        {!hasError ? (
                                                            isVid ? (
                                                                <video src={url}
                                                                    style={{ width: '100%', height: '100%', objectFit: 'cover' }}
                                                                    onError={() => handleMediaError(variantIdx)} />
                                                            ) : (
                                                                <img src={url} alt={`Variation ${variantIdx + 1}`}
                                                                    style={{ width: '100%', height: '100%', objectFit: 'cover' }}
                                                                    onError={() => handleMediaError(variantIdx)} />
                                                            )
                                                        ) : (
                                                            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center',
                                                                height: '100%', color: '#65676b', padding: '12px', textAlign: 'center' }}>
                                                                <div>
                                                                    <div style={{ fontSize: '24px', marginBottom: '4px' }}>üñºÔ∏è</div>
                                                                    <div style={{ fontSize: '12px' }}>Failed to load</div>
                                                                </div>
                                                            </div>
                                                        )}
                                                        {/* Swap button on variant */}
                                                        {isAuthenticated && (
                                                            <button
                                                                onClick={(e) => { e.stopPropagation(); setSwappingMedia(swappingMedia === variantIdx ? null : variantIdx); }}
                                                                style={{
                                                                    position: 'absolute', top: '6px', right: '6px',
                                                                    backgroundColor: 'rgba(0,0,0,0.7)', color: 'white',
                                                                    border: 'none', borderRadius: '6px', padding: '4px 8px',
                                                                    fontSize: '11px', fontWeight: '600', cursor: 'pointer', zIndex: 5
                                                                }}
                                                            >
                                                                üîÑ
                                                            </button>
                                                        )}
                                                    </div>
                                                    <div style={{
                                                        padding: '6px 8px', fontSize: '11px', fontWeight: '600',
                                                        color: '#65676b', textAlign: 'center', borderTop: '1px solid #e4e6eb'
                                                    }}>
                                                        {isVid ? 'Video' : 'Image'} Variation {variantIdx + 1}
                                                    </div>
                                                    {/* URL input for swapping variant */}
                                                    {swappingMedia === variantIdx && (
                                                        <div style={{
                                                            padding: '8px', backgroundColor: '#f0f7ff',
                                                            borderTop: '2px solid #1877f2'
                                                        }}>
                                                            <input
                                                                type="text"
                                                                placeholder="Paste GDrive link or URL..."
                                                                value={editState[`mediaUrl_${variantIdx}`] || ''}
                                                                onChange={e => onContentChange(asset.rowIndex, `mediaUrl_${variantIdx}`, e.target.value)}
                                                                autoFocus
                                                                style={{
                                                                    width: '100%', padding: '6px 8px', border: '2px solid #d1e0ff',
                                                                    borderRadius: '6px', fontSize: '12px', outline: 'none'
                                                                }}
                                                            />
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}
                            </div>
                        )}

                        {/* URL Preview Bar - Headline editable when authenticated */}
                        <div style={{
                            padding: '12px', backgroundColor: '#f0f2f5',
                            borderTop: '1px solid #e4e6eb',
                            display: 'flex', alignItems: 'center', justifyContent: 'space-between', gap: '12px'
                        }}>
                            <div style={{ flex: 1 }}>
                                <div style={{ fontSize: '12px', color: '#65676b', textTransform: 'uppercase', marginBottom: '4px' }}>
                                    {displayUrl}
                                </div>
                                {isAuthenticated ? (
                                    <input
                                        type="text"
                                        value={displayHeadline}
                                        onChange={e => onContentChange(asset.rowIndex, 'headline', e.target.value)}
                                        placeholder="Ad Headline..."
                                        style={{
                                            width: '100%', padding: '6px 8px', border: '2px solid #d1e0ff',
                                            borderRadius: '6px', fontSize: '15px', fontWeight: '600',
                                            color: '#050505', backgroundColor: '#f8faff', outline: 'none'
                                        }}
                                    />
                                ) : (
                                    <div style={{ fontSize: '15px', fontWeight: '600', color: '#050505', lineHeight: '1.3' }}>
                                        {displayHeadline || asset.adName || 'Ad Headline'}
                                    </div>
                                )}
                            </div>
                            <button style={{
                                padding: '8px 16px', backgroundColor: '#e4e6eb', color: '#050505',
                                border: 'none', borderRadius: '6px', fontSize: '14px', fontWeight: '600',
                                cursor: 'default', whiteSpace: 'nowrap', flexShrink: 0
                            }}>
                                Learn more
                            </button>
                        </div>

                        {/* Description - Editable when authenticated */}
                        {(isAuthenticated || displayDescription) && (
                            <div style={{ padding: '8px 12px', borderTop: '1px solid #e4e6eb' }}>
                                <div style={{ fontSize: '11px', color: '#65676b', textTransform: 'uppercase', marginBottom: '4px', fontWeight: '600' }}>
                                    Description
                                </div>
                                {isAuthenticated ? (
                                    <input
                                        type="text"
                                        value={displayDescription}
                                        onChange={e => onContentChange(asset.rowIndex, 'description', e.target.value)}
                                        placeholder="Ad description..."
                                        style={{
                                            width: '100%', padding: '6px 8px', border: '2px solid #d1e0ff',
                                            borderRadius: '6px', fontSize: '13px', color: '#050505',
                                            backgroundColor: '#f8faff', outline: 'none'
                                        }}
                                    />
                                ) : (
                                    <div style={{ fontSize: '13px', color: '#65676b', lineHeight: '1.4' }}>
                                        {displayDescription}
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Save Changes Button (only when editing) */}
                        {isAuthenticated && hasChanges && (
                            <div style={{ padding: '8px 12px' }}>
                                <button
                                    onClick={() => onContentSave(asset)}
                                    disabled={isSaving}
                                    style={{
                                        width: '100%', padding: '10px', backgroundColor: isSaving ? '#93c5fd' : '#1877f2',
                                        color: 'white', border: 'none', borderRadius: '6px',
                                        fontSize: '14px', fontWeight: '600',
                                        cursor: isSaving ? 'not-allowed' : 'pointer'
                                    }}
                                >
                                    {isSaving ? 'Saving...' : 'Save Changes'}
                                </button>
                            </div>
                        )}

                        {/* Engagement Buttons (decorative) */}
                        <div style={{
                            display: 'flex', justifyContent: 'space-around', padding: '8px 12px',
                            borderTop: '1px solid #e4e6eb', borderBottom: '1px solid #e4e6eb'
                        }}>
                            {['üëç Like', 'üí¨ Comment', '‚ÜóÔ∏è Share'].map((action, idx) => (
                                <div key={idx} style={{
                                    flex: 1, textAlign: 'center', padding: '8px',
                                    fontSize: '13px', color: '#65676b', fontWeight: '600'
                                }}>
                                    {action}
                                </div>
                            ))}
                        </div>

                        {/* Feedback Notes */}
                        <div style={{ padding: '12px' }}>
                            <div style={{
                                fontSize: '12px', fontWeight: '600', color: '#65676b',
                                marginBottom: '8px', textTransform: 'uppercase'
                            }}>
                                Feedback Notes
                            </div>
                            <textarea
                                placeholder="Add feedback notes (optional)..."
                                value={editNotes[asset.rowIndex] || asset.clientNote || ''}
                                onChange={e => onNotesChange(asset.rowIndex, e.target.value)}
                                disabled={updating[asset.rowIndex]}
                                style={{
                                    width: '100%', minHeight: '70px', padding: '10px',
                                    borderRadius: '8px', border: '1px solid #e4e6eb',
                                    fontSize: '14px', fontFamily: 'inherit', resize: 'vertical',
                                    backgroundColor: '#f0f2f5',
                                    opacity: updating[asset.rowIndex] ? 0.5 : 1
                                }}
                            />
                        </div>

                        {/* Team Notes - Collapsible */}
                        <div style={{ borderTop: '1px solid #e4e6eb' }}>
                            <button
                                onClick={() => setShowNotes(!showNotes)}
                                style={{
                                    width: '100%', padding: '10px 12px', border: 'none',
                                    backgroundColor: showNotes ? '#f0f7ff' : '#f8f9fa', cursor: 'pointer',
                                    display: 'flex', alignItems: 'center', justifyContent: 'space-between',
                                    fontSize: '13px', fontWeight: '600',
                                    color: showNotes ? '#1877f2' : '#65676b'
                                }}
                            >
                                <span>
                                    Notes{noteCount > 0 ? ` (${noteCount})` : ''}
                                </span>
                                <span style={{
                                    fontSize: '16px', transition: 'transform 0.2s',
                                    transform: showNotes ? 'rotate(180deg)' : 'rotate(0deg)'
                                }}>
                                    ‚ñº
                                </span>
                            </button>

                            {showNotes && (
                                <div style={{ backgroundColor: '#f8f9fa', padding: '12px' }}>
                                    {/* Notes Timeline */}
                                    {cardNotes.length > 0 ? (
                                        <div style={{ marginBottom: '12px', display: 'flex', flexDirection: 'column', gap: '8px' }}>
                                            {cardNotes.map((note, idx) => (
                                                <div key={idx} style={{
                                                    backgroundColor: 'white', borderRadius: '8px',
                                                    padding: '10px 12px', border: '1px solid #e4e6eb'
                                                }}>
                                                    <div style={{
                                                        display: 'flex', justifyContent: 'space-between',
                                                        alignItems: 'center', marginBottom: '4px'
                                                    }}>
                                                        <span style={{
                                                            fontSize: '13px', fontWeight: '600', color: '#050505'
                                                        }}>
                                                            {note.author}
                                                        </span>
                                                        <span style={{
                                                            fontSize: '11px', color: '#65676b'
                                                        }}>
                                                            {getRelativeTime(note.timestamp)}
                                                        </span>
                                                    </div>
                                                    <div style={{
                                                        fontSize: '13px', color: '#050505', lineHeight: '1.4',
                                                        whiteSpace: 'pre-wrap'
                                                    }}>
                                                        {note.noteText}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    ) : (
                                        <div style={{
                                            fontSize: '13px', color: '#65676b', textAlign: 'center',
                                            padding: '8px 0', marginBottom: '12px'
                                        }}>
                                            No notes yet. Be the first to add one.
                                        </div>
                                    )}

                                    {/* Add Note Input */}
                                    <div style={{
                                        display: 'flex', gap: '8px', alignItems: 'flex-start'
                                    }}>
                                        <input
                                            type="text"
                                            value={authorName}
                                            onChange={e => onAuthorChange(e.target.value)}
                                            placeholder="Your name"
                                            style={{
                                                width: '100px', padding: '8px 10px',
                                                border: '1px solid #e4e6eb', borderRadius: '6px',
                                                fontSize: '12px', backgroundColor: 'white',
                                                outline: 'none', flexShrink: 0
                                            }}
                                        />
                                        <input
                                            type="text"
                                            value={newNoteText}
                                            onChange={e => setNewNoteText(e.target.value)}
                                            onKeyDown={e => {
                                                if (e.key === 'Enter' && newNoteText.trim() && authorName.trim()) {
                                                    onPostNote(asset, newNoteText);
                                                    setNewNoteText('');
                                                }
                                            }}
                                            placeholder="Type a note..."
                                            disabled={isPostingNote}
                                            style={{
                                                flex: 1, padding: '8px 10px',
                                                border: '1px solid #e4e6eb', borderRadius: '6px',
                                                fontSize: '13px', backgroundColor: 'white',
                                                outline: 'none', opacity: isPostingNote ? 0.5 : 1
                                            }}
                                        />
                                        <button
                                            onClick={() => {
                                                if (newNoteText.trim() && authorName.trim()) {
                                                    onPostNote(asset, newNoteText);
                                                    setNewNoteText('');
                                                }
                                            }}
                                            disabled={!newNoteText.trim() || !authorName.trim() || isPostingNote}
                                            style={{
                                                padding: '8px 14px', backgroundColor:
                                                    (!newNoteText.trim() || !authorName.trim() || isPostingNote) ? '#e4e6eb' : '#1877f2',
                                                color: (!newNoteText.trim() || !authorName.trim() || isPostingNote) ? '#65676b' : 'white',
                                                border: 'none', borderRadius: '6px',
                                                fontSize: '12px', fontWeight: '600',
                                                cursor: (!newNoteText.trim() || !authorName.trim() || isPostingNote) ? 'not-allowed' : 'pointer',
                                                flexShrink: 0
                                            }}
                                        >
                                            {isPostingNote ? 'Posting...' : 'Post'}
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Approval Buttons */}
                        <div style={{
                            display: 'grid', gridTemplateColumns: '1fr 1fr 1fr',
                            gap: '8px', padding: '0 12px 12px 12px'
                        }}>
                            {[
                                { label: 'Approve', icon: '‚úì', status: 'Approved', color: '#10b981' },
                                { label: 'Edit', icon: '‚úèÔ∏è', status: 'Needs Edit', color: '#f59e0b' },
                                { label: 'Reject', icon: '‚úó', status: 'Rejected', color: '#ef4444' }
                            ].map((btn, idx) => (
                                <button
                                    key={idx}
                                    onClick={() => onStatusUpdate(asset, btn.status)}
                                    disabled={updating[asset.rowIndex]}
                                    style={{
                                        padding: '10px 8px',
                                        backgroundColor: updating[asset.rowIndex] ? '#ccc' : btn.color,
                                        color: 'white', border: 'none', borderRadius: '6px',
                                        fontSize: '13px', fontWeight: '600',
                                        cursor: updating[asset.rowIndex] ? 'not-allowed' : 'pointer',
                                        display: 'flex', alignItems: 'center', justifyContent: 'center',
                                        gap: '4px', transition: 'opacity 0.2s'
                                    }}
                                    onMouseOver={e => { if (!updating[asset.rowIndex]) e.target.style.opacity = '0.9'; }}
                                    onMouseOut={e => { e.target.style.opacity = '1'; }}
                                >
                                    {updating[asset.rowIndex] ? '‚è≥' : `${btn.icon} ${btn.label}`}
                                </button>
                            ))}
                        </div>
                    </div>

                    {lightboxUrl && (
                        <Lightbox
                            mediaUrl={lightboxUrl}
                            mediaType={lightboxType}
                            onClose={() => setLightboxUrl(null)}
                        />
                    )}
                </>
            );
        };

        // =====================================================
        // MAIN PORTAL COMPONENT
        // =====================================================

        const CreativeApprovalPortal = () => {
            const [creativeAssets, setCreativeAssets] = useState([]);
            const [clientInfo, setClientInfo] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [editNotes, setEditNotes] = useState({});
            const [updating, setUpdating] = useState({});
            const [activeFilter, setActiveFilter] = useState('all');
            const [adStatusFilter, setAdStatusFilter] = useState('all');

            // Edit mode state
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [showPasscodeModal, setShowPasscodeModal] = useState(false);
            const [editingContent, setEditingContent] = useState({});
            const [savingContent, setSavingContent] = useState({});

            // Activity notes state
            const [activityNotes, setActivityNotes] = useState({});   // { rowIndex: [notes] }
            const [authorName, setAuthorName] = useState(
                sessionStorage.getItem('portalAuthorName') || ''
            );
            const [postingNote, setPostingNote] = useState({});       // { rowIndex: true } while posting

            useEffect(() => { fetchData(); }, []);

            const fetchData = async () => {
                try {
                    setLoading(true);
                    setError(null);

                    const [assetsResponse, clientResponse, activityResponse] = await Promise.all([
                        fetch(`https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/${CONFIG.CREATIVE_ASSETS_SHEET}?key=${CONFIG.API_KEY}`),
                        fetch(`https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/${CONFIG.CLIENT_INFO_SHEET}?key=${CONFIG.API_KEY}`),
                        fetch(`https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/${CONFIG.ACTIVITY_LOG_SHEET}?key=${CONFIG.API_KEY}`)
                            .catch(() => ({ ok: false })) // Don't fail if Activity Log tab doesn't exist yet
                    ]);

                    if (!assetsResponse.ok || !clientResponse.ok) {
                        throw new Error('Failed to fetch data from Google Sheets');
                    }

                    const assetsData = await assetsResponse.json();
                    const clientData = await clientResponse.json();

                    // Parse activity log into grouped map { rowIndex: [notes] }
                    const notesMap = {};
                    if (activityResponse.ok) {
                        try {
                            const activityData = await activityResponse.json();
                            if (activityData.values && activityData.values.length > 1) {
                                activityData.values.slice(1).forEach(row => {
                                    const timestamp = row[0] || '';
                                    const rowIndex = parseInt(row[1]);
                                    const author = row[2] || '';
                                    const noteText = row[3] || '';
                                    if (rowIndex && noteText) {
                                        if (!notesMap[rowIndex]) notesMap[rowIndex] = [];
                                        notesMap[rowIndex].push({ timestamp, author, noteText });
                                    }
                                });
                            }
                        } catch (e) { /* Activity log parse error - ignore */ }
                    }
                    setActivityNotes(notesMap);

                    let extractedClientInfo = {
                        businessName: '', websiteUrl: '', destinationUrl: '', profileImage: ''
                    };

                    if (clientData.values && clientData.values.length > 1) {
                        const clientRow = clientData.values[1];
                        extractedClientInfo = {
                            businessName: clientRow[CONFIG.CLIENT_COLUMNS.BUSINESS_NAME] || '',
                            websiteUrl: clientRow[CONFIG.CLIENT_COLUMNS.WEBSITE_URL] || '',
                            destinationUrl: clientRow[CONFIG.CLIENT_COLUMNS.DESTINATION_URL] || '',
                            profileImage: clientRow[CONFIG.CLIENT_COLUMNS.PROFILE_IMAGE] || ''
                        };
                    }
                    setClientInfo(extractedClientInfo);

                    if (assetsData.values && assetsData.values.length > 1) {
                        const assets = assetsData.values.slice(1).map((row, index) => {
                            // Build media URLs array: Column I first, then M, N, O, P
                            // Column I is already formula-converted; fall back to converting Column H
                            const primaryUrl = row[CONFIG.ASSETS_COLUMNS.DIRECT_URL] ||
                                convertMediaUrl(row[CONFIG.ASSETS_COLUMNS.GDRIVE_LINK]);
                            const rawMediaUrls = [
                                primaryUrl,
                                convertMediaUrl(row[CONFIG.ASSETS_COLUMNS.MEDIA_2]),
                                convertMediaUrl(row[CONFIG.ASSETS_COLUMNS.MEDIA_3]),
                                convertMediaUrl(row[CONFIG.ASSETS_COLUMNS.MEDIA_4]),
                                convertMediaUrl(row[CONFIG.ASSETS_COLUMNS.MEDIA_5])
                            ].filter(url => url !== null && url !== undefined && url.trim() !== '');

                            return {
                                rowIndex: index + 2,
                                approvalStatus: row[CONFIG.ASSETS_COLUMNS.APPROVAL_STATUS] || 'Pending',
                                adStatus: row[CONFIG.ASSETS_COLUMNS.AD_STATUS] || 'Draft',
                                adName: row[CONFIG.ASSETS_COLUMNS.AD_NAME] || '',
                                description: row[CONFIG.ASSETS_COLUMNS.DESCRIPTION] || '',
                                campaignAngle: row[CONFIG.ASSETS_COLUMNS.CAMPAIGN_ANGLE] || '',
                                headline: row[CONFIG.ASSETS_COLUMNS.HEADLINE] || '',
                                adCopyBody: row[CONFIG.ASSETS_COLUMNS.AD_COPY_BODY] || '',
                                mediaUrls: rawMediaUrls,
                                assetUrl: rawMediaUrls[0] || '',
                                clientNote: row[CONFIG.ASSETS_COLUMNS.CLIENT_NOTE] || ''
                            };
                        });

                        setCreativeAssets(assets);
                    }

                    setLoading(false);
                } catch (err) {
                    console.error('Error:', err);
                    setError(err.message);
                    setLoading(false);
                }
            };

            const updateAssetStatus = async (asset, newStatus) => {
                const notes = editNotes[asset.rowIndex] !== undefined
                    ? editNotes[asset.rowIndex]
                    : (asset.clientNote || '');
                setUpdating(prev => ({ ...prev, [asset.rowIndex]: true }));

                try {
                    await fetch(CONFIG.APPS_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'updateApprovalStatus',
                            rowIndex: asset.rowIndex,
                            approvalStatus: newStatus,
                            clientNote: notes,
                            adName: asset.adName
                        })
                    });

                    setCreativeAssets(prev =>
                        prev.map(a =>
                            a.rowIndex === asset.rowIndex
                                ? { ...a, approvalStatus: newStatus, clientNote: notes }
                                : a
                        )
                    );

                    setEditNotes(prev => {
                        const updated = { ...prev };
                        delete updated[asset.rowIndex];
                        return updated;
                    });

                    showNotification(`‚úì Status: ${newStatus}!`, 'success');

                    // Send n8n notification for approval status change
                    sendNotification('approval', {
                        adName: asset.adName,
                        details: newStatus
                    });

                } catch (err) {
                    showNotification('‚úó Failed to update', 'error');
                } finally {
                    setUpdating(prev => {
                        const updated = { ...prev };
                        delete updated[asset.rowIndex];
                        return updated;
                    });
                }
            };

            const updateAdContent = async (asset) => {
                const edits = editingContent[asset.rowIndex];
                if (!edits) return;

                setSavingContent(prev => ({ ...prev, [asset.rowIndex]: true }));

                // Build media URLs payload (raw URLs that the user pasted)
                const mediaUpdates = {};
                if (edits.mediaUrl_0 !== undefined) mediaUpdates.gdriveLink = edits.mediaUrl_0;
                if (edits.mediaUrl_1 !== undefined) mediaUpdates.media2 = edits.mediaUrl_1;
                if (edits.mediaUrl_2 !== undefined) mediaUpdates.media3 = edits.mediaUrl_2;
                if (edits.mediaUrl_3 !== undefined) mediaUpdates.media4 = edits.mediaUrl_3;
                if (edits.mediaUrl_4 !== undefined) mediaUpdates.media5 = edits.mediaUrl_4;

                try {
                    await fetch(CONFIG.APPS_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'updateAdContent',
                            rowIndex: asset.rowIndex,
                            headline: edits.headline !== undefined ? edits.headline : asset.headline,
                            adCopyBody: edits.adCopyBody !== undefined ? edits.adCopyBody : asset.adCopyBody,
                            description: edits.description !== undefined ? edits.description : asset.description,
                            adName: asset.adName,
                            ...mediaUpdates
                        })
                    });

                    // Optimistic update for text fields
                    const updatedAsset = {
                        headline: edits.headline !== undefined ? edits.headline : asset.headline,
                        adCopyBody: edits.adCopyBody !== undefined ? edits.adCopyBody : asset.adCopyBody,
                        description: edits.description !== undefined ? edits.description : asset.description
                    };

                    // Optimistic update for media URLs (convert and rebuild mediaUrls array)
                    const newMediaUrls = [...(asset.mediaUrls || [])];
                    if (edits.mediaUrl_0 !== undefined) {
                        newMediaUrls[0] = convertMediaUrl(edits.mediaUrl_0) || newMediaUrls[0];
                    }
                    for (let i = 1; i <= 4; i++) {
                        if (edits[`mediaUrl_${i}`] !== undefined) {
                            const converted = convertMediaUrl(edits[`mediaUrl_${i}`]);
                            if (converted) {
                                newMediaUrls[i] = converted;
                            }
                        }
                    }

                    setCreativeAssets(prev =>
                        prev.map(a =>
                            a.rowIndex === asset.rowIndex
                                ? {
                                    ...a,
                                    ...updatedAsset,
                                    mediaUrls: newMediaUrls.filter(u => u),
                                    assetUrl: newMediaUrls[0] || a.assetUrl
                                }
                                : a
                        )
                    );

                    // Clear edit state for this row
                    setEditingContent(prev => {
                        const updated = { ...prev };
                        delete updated[asset.rowIndex];
                        return updated;
                    });

                    showNotification('‚úì Content updated!', 'success');

                    // Send n8n notification for content edit
                    sendNotification('content_edit', {
                        adName: asset.adName,
                        details: 'Content updated',
                        author: authorName || 'Team member'
                    });
                } catch (err) {
                    showNotification('‚úó Failed to save changes', 'error');
                } finally {
                    setSavingContent(prev => {
                        const updated = { ...prev };
                        delete updated[asset.rowIndex];
                        return updated;
                    });
                }
            };

            const handleContentChange = (rowIndex, field, value) => {
                setEditingContent(prev => ({
                    ...prev,
                    [rowIndex]: { ...prev[rowIndex], [field]: value }
                }));
            };

            const handleNotesChange = (rowIndex, value) => {
                setEditNotes(prev => ({ ...prev, [rowIndex]: value }));
            };

            const handleAuthorChange = (name) => {
                setAuthorName(name);
                sessionStorage.setItem('portalAuthorName', name);
            };

            const postNote = async (asset, noteText) => {
                if (!noteText.trim() || !authorName.trim()) return;

                setPostingNote(prev => ({ ...prev, [asset.rowIndex]: true }));

                try {
                    await fetch(CONFIG.APPS_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'addNote',
                            rowIndex: asset.rowIndex,
                            author: authorName.trim(),
                            noteText: noteText.trim()
                        })
                    });

                    // Optimistic UI update
                    const newNote = {
                        timestamp: new Date().toISOString(),
                        author: authorName.trim(),
                        noteText: noteText.trim()
                    };
                    setActivityNotes(prev => ({
                        ...prev,
                        [asset.rowIndex]: [...(prev[asset.rowIndex] || []), newNote]
                    }));

                    // Send n8n notification
                    sendNotification('note_posted', {
                        adName: asset.adName,
                        details: noteText.trim(),
                        author: authorName.trim()
                    });

                    showNotification('Note posted!', 'success');
                } catch (err) {
                    showNotification('Failed to post note', 'error');
                } finally {
                    setPostingNote(prev => {
                        const updated = { ...prev };
                        delete updated[asset.rowIndex];
                        return updated;
                    });
                }
            };

            const showNotification = (message, type) => {
                const notification = document.createElement('div');
                notification.textContent = message;
                notification.style.cssText = `
                    position: fixed; top: 20px; right: 20px; padding: 16px 24px;
                    background-color: ${type === 'success' ? '#10b981' : '#ef4444'};
                    color: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 9999; animation: slideIn 0.3s ease-out; font-size: 14px; font-weight: 600;
                `;
                document.body.appendChild(notification);
                setTimeout(() => {
                    notification.style.animation = 'slideOut 0.3s ease-in';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            };

            const getFilteredAssets = () => {
                let filtered = creativeAssets;

                if (activeFilter !== 'all') {
                    filtered = filtered.filter(asset =>
                        asset.approvalStatus?.toLowerCase() === activeFilter ||
                        (!asset.approvalStatus && activeFilter === 'pending')
                    );
                }

                if (adStatusFilter !== 'all') {
                    filtered = filtered.filter(asset => {
                        const statusInfo = getAdStatusInfo(asset.adStatus);
                        if (adStatusFilter === 'live' && statusInfo === CONFIG.AD_STATUSES.LIVE) return true;
                        if (adStatusFilter === 'in_draft' && statusInfo === CONFIG.AD_STATUSES.IN_DRAFT) return true;
                        if (adStatusFilter === 'launched_leads_no_calls' && statusInfo === CONFIG.AD_STATUSES.LAUNCHED_LEADS_NO_CALLS) return true;
                        if (adStatusFilter === 'launched_no_leads' && statusInfo === CONFIG.AD_STATUSES.LAUNCHED_NO_LEADS) return true;
                        if (adStatusFilter === 'rejected_by_meta' && statusInfo === CONFIG.AD_STATUSES.REJECTED_BY_META) return true;
                        if (adStatusFilter === 'not_launched' && statusInfo === CONFIG.AD_STATUSES.NOT_LAUNCHED) return true;
                        return false;
                    });
                }

                return filtered;
            };

            const getStats = () => {
                const total = creativeAssets.length;
                const pending = creativeAssets.filter(a => !a.approvalStatus || a.approvalStatus.toLowerCase() === 'pending').length;
                const approved = creativeAssets.filter(a => a.approvalStatus?.toLowerCase() === 'approved').length;
                const needsEdit = creativeAssets.filter(a => a.approvalStatus?.toLowerCase() === 'needs edit').length;
                const rejected = creativeAssets.filter(a => a.approvalStatus?.toLowerCase() === 'rejected').length;
                return { total, pending, approved, needsEdit, rejected };
            };

            if (loading) {
                return (
                    <div style={{
                        display: 'flex', justifyContent: 'center', alignItems: 'center',
                        minHeight: '100vh', flexDirection: 'column', gap: '20px'
                    }}>
                        <div className="spinner"></div>
                        <div style={{ fontSize: '18px', color: '#666' }}>Loading creative assets...</div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div style={{
                        display: 'flex', justifyContent: 'center', alignItems: 'center',
                        minHeight: '100vh', padding: '20px'
                    }}>
                        <div style={{
                            textAlign: 'center', maxWidth: '600px', backgroundColor: 'white',
                            padding: '40px', borderRadius: '12px', boxShadow: '0 4px 12px rgba(0,0,0,0.1)'
                        }}>
                            <div style={{ fontSize: '48px', marginBottom: '16px' }}>‚ö†Ô∏è</div>
                            <h2 style={{ fontSize: '24px', marginBottom: '16px', color: '#ef4444' }}>
                                Connection Error
                            </h2>
                            <div style={{ color: '#666', lineHeight: '1.6' }}>{error}</div>
                        </div>
                    </div>
                );
            }

            const stats = getStats();
            const filteredAssets = getFilteredAssets();

            return (
                <div style={{ minHeight: '100vh', backgroundColor: '#f0f2f5', padding: '20px 40px' }}>
                    <div style={{ maxWidth: '1600px', margin: '0 auto' }}>
                        {/* Header */}
                        <div style={{
                            marginBottom: '20px', padding: '20px', backgroundColor: 'white',
                            borderRadius: '12px', boxShadow: '0 2px 8px rgba(0,0,0,0.1)',
                            display: 'flex', justifyContent: 'space-between', alignItems: 'center',
                            flexWrap: 'wrap', gap: '12px'
                        }}>
                            <div>
                                <h1 style={{ fontSize: '28px', fontWeight: '700', color: '#050505', marginBottom: '4px' }}>
                                    üé® Ads Approval Portal
                                </h1>
                                <p style={{ fontSize: '14px', color: '#65676b' }}>
                                    {clientInfo?.businessName || 'Client'}
                                </p>
                            </div>
                            <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
                                {isAuthenticated && (
                                    <div style={{
                                        padding: '8px 14px', backgroundColor: '#e7f0ff', color: '#1877f2',
                                        borderRadius: '6px', fontSize: '13px', fontWeight: '600'
                                    }}>
                                        ‚úèÔ∏è Edit Mode
                                    </div>
                                )}
                                <a
                                    href={CONFIG.GDRIVE_FOLDER_URL}
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    style={{
                                        padding: '10px 20px', backgroundColor: '#f0f2f5', color: '#050505',
                                        border: '1px solid #dadde1', borderRadius: '6px', fontSize: '14px',
                                        fontWeight: '600', cursor: 'pointer', textDecoration: 'none',
                                        display: 'inline-flex', alignItems: 'center', gap: '6px'
                                    }}
                                >
                                    üìÅ Creative Assets
                                </a>
                                <button
                                    onClick={() => window.location.reload()}
                                    style={{
                                        padding: '10px 20px', backgroundColor: '#1877f2', color: 'white',
                                        border: 'none', borderRadius: '6px', fontSize: '14px',
                                        fontWeight: '600', cursor: 'pointer'
                                    }}
                                >
                                    üîÑ Refresh
                                </button>
                            </div>
                        </div>

                        {/* Stats */}
                        <div style={{
                            display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(140px, 1fr))',
                            gap: '12px', marginBottom: '20px'
                        }}>
                            {[
                                { count: stats.total, label: 'Total', color: '#6b7280' },
                                { count: stats.pending, label: 'Pending', color: '#1877f2' },
                                { count: stats.approved, label: 'Approved', color: '#10b981' },
                                { count: stats.needsEdit, label: 'Needs Edit', color: '#f59e0b' },
                                { count: stats.rejected, label: 'Rejected', color: '#ef4444' }
                            ].map((stat, idx) => (
                                <div key={idx} style={{
                                    backgroundColor: 'white', padding: '16px', borderRadius: '8px',
                                    boxShadow: '0 1px 3px rgba(0,0,0,0.1)', textAlign: 'center'
                                }}>
                                    <div style={{ fontSize: '32px', fontWeight: '700', color: stat.color }}>
                                        {stat.count}
                                    </div>
                                    <div style={{ fontSize: '13px', color: '#65676b', marginTop: '4px' }}>
                                        {stat.label}
                                    </div>
                                </div>
                            ))}
                        </div>

                        {/* Approval Status Filter */}
                        <div style={{ marginBottom: '12px' }}>
                            <div style={{ fontSize: '12px', fontWeight: '600', color: '#65676b', marginBottom: '8px', textTransform: 'uppercase' }}>
                                Approval Status
                            </div>
                            <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                                {[
                                    { id: 'all', label: 'All' },
                                    { id: 'pending', label: 'Pending' },
                                    { id: 'approved', label: 'Approved' },
                                    { id: 'needs edit', label: 'Needs Edit' },
                                    { id: 'rejected', label: 'Rejected' }
                                ].map(tab => (
                                    <button key={tab.id} onClick={() => setActiveFilter(tab.id)}
                                        style={{
                                            padding: '8px 16px',
                                            backgroundColor: activeFilter === tab.id ? '#1877f2' : 'white',
                                            color: activeFilter === tab.id ? 'white' : '#65676b',
                                            border: 'none', borderRadius: '8px', fontSize: '13px',
                                            fontWeight: '600', cursor: 'pointer',
                                            boxShadow: '0 1px 3px rgba(0,0,0,0.1)'
                                        }}>
                                        {tab.label}
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* Ad Status Filter */}
                        <div style={{ marginBottom: '24px' }}>
                            <div style={{ fontSize: '12px', fontWeight: '600', color: '#65676b', marginBottom: '8px', textTransform: 'uppercase' }}>
                                Ad Status
                            </div>
                            <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                                {[
                                    { id: 'all', label: 'All', color: '#6b7280' },
                                    { id: 'live', label: 'üü¢ Live', color: '#10b981' },
                                    { id: 'in_draft', label: 'üìù In Draft', color: '#6b7280' },
                                    { id: 'launched_leads_no_calls', label: 'üìû Leads, No Calls', color: '#f59e0b' },
                                    { id: 'launched_no_leads', label: 'üìâ No Leads', color: '#ef4444' },
                                    { id: 'rejected_by_meta', label: 'üö´ Rejected by Meta', color: '#dc2626' },
                                    { id: 'not_launched', label: '‚è∏Ô∏è Not Launched', color: '#9ca3af' }
                                ].map(tab => (
                                    <button key={tab.id} onClick={() => setAdStatusFilter(tab.id)}
                                        style={{
                                            padding: '8px 16px',
                                            backgroundColor: adStatusFilter === tab.id ? tab.color : 'white',
                                            color: adStatusFilter === tab.id ? 'white' : '#65676b',
                                            border: 'none', borderRadius: '8px', fontSize: '13px',
                                            fontWeight: '600', cursor: 'pointer',
                                            boxShadow: '0 1px 3px rgba(0,0,0,0.1)'
                                        }}>
                                        {tab.label}
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* Cards Grid */}
                        {filteredAssets.length === 0 ? (
                            <div style={{
                                backgroundColor: 'white', borderRadius: '12px', padding: '60px 20px',
                                textAlign: 'center', boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
                            }}>
                                <div style={{ fontSize: '48px', marginBottom: '16px' }}>üì≠</div>
                                <div style={{ fontSize: '20px', fontWeight: '600', color: '#050505' }}>
                                    No ads found
                                </div>
                                <div style={{ fontSize: '14px', color: '#65676b', marginTop: '8px' }}>
                                    Add creative assets to your sheet
                                </div>
                            </div>
                        ) : (
                            <div style={{
                                display: 'grid',
                                gridTemplateColumns: 'repeat(auto-fill, minmax(380px, 1fr))',
                                gap: '32px'
                            }}>
                                {filteredAssets.map((asset) => (
                                    <CreativeAssetCard
                                        key={asset.rowIndex}
                                        asset={asset}
                                        clientInfo={clientInfo}
                                        updating={updating}
                                        onStatusUpdate={updateAssetStatus}
                                        editNotes={editNotes}
                                        onNotesChange={handleNotesChange}
                                        isAuthenticated={isAuthenticated}
                                        editingContent={editingContent}
                                        onContentChange={handleContentChange}
                                        onContentSave={updateAdContent}
                                        savingContent={savingContent}
                                        onEditClick={() => setShowPasscodeModal(true)}
                                        activityNotes={activityNotes}
                                        authorName={authorName}
                                        onAuthorChange={handleAuthorChange}
                                        onPostNote={postNote}
                                        postingNote={postingNote}
                                    />
                                ))}
                            </div>
                        )}
                    </div>

                    {/* Passcode Modal */}
                    {showPasscodeModal && (
                        <PasscodeModal
                            onSuccess={() => setIsAuthenticated(true)}
                            onClose={() => setShowPasscodeModal(false)}
                        />
                    )}

                    <style>
                        {`
                            @keyframes slideIn {
                                from { transform: translateX(400px); opacity: 0; }
                                to { transform: translateX(0); opacity: 1; }
                            }
                            @keyframes slideOut {
                                from { transform: translateX(0); opacity: 1; }
                                to { transform: translateX(400px); opacity: 0; }
                            }
                            @media (max-width: 768px) {
                                div[style*="gridTemplateColumns"] {
                                    grid-template-columns: 1fr !important;
                                }
                            }
                        `}
                    </style>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<CreativeApprovalPortal />);
    </script>
</body>
</html>
